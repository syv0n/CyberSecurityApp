<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Submission Details</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
      body {
        font-family: "Roboto", sans-serif;
        line-height: 1.6;
        color: #333;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      h1, h2 {
        color: #2c3e50;
        border-bottom: 2px solid #3498db;
        padding-bottom: 10px;
      }
      .score-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .final-score {
        font-size: 48px;
        font-weight: bold;
        color: #27ae60;
      }

      .score-label {
          font-size: 16px;
          color: #666;
          margin-top: 5px;
      }
      .score-chart {
        width: 300px;
        height: 300px;
      }
      .function-scores {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
      }
      .function-score {
        width: 48%;
        margin-bottom: 10px;
        padding: 15px;
        background-color: #f0f0f0;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
      }
      .function-score:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      }
      .button-container {
        margin-top: 20px;
        text-align: center;
      }
      button {
        padding: 10px 20px;
        font-size: 16px;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }
      button:hover {
        background-color: #2980b9;
      }
      .interpretation, .suggestions {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      }
      .interpretation ul, .suggestions ul {
        padding-left: 20px;
      }
      .interpretation li, .suggestions li {
        margin-bottom: 10px;
      }
      @media print {
        .button-container, .no-print {
          display: none !important;
        }
        body {
          print-color-adjust: exact;
          -webkit-print-color-adjust: exact;
        }
      }
    </style>
  </head>
  <body>
    <h1>Submission Details</h1>
    <div class="score-container">
      <div>
        <div class="final-score" id="finalScore">0.00</div>
        <div class="score-label">Final Maturity Score</div>
      </div>
      <canvas id="scoreChart" class="score-chart"></canvas>
    </div>
    <div class="interpretation">
      <h2>Interpretation</h2>
      <p id="interpretationText"></p>
    </div>
    <div class="suggestions">
      <h2>Suggestions for Improvement</h2>
      <ul id="suggestionList"></ul>
    </div>
    <h2>Function Scores</h2>
    <div class="function-scores" id="functionScores"></div>
    <div class="button-container no-print">
      <button onclick="window.print()">Print Report</button>
      <button onclick="window.location.href='submission_history.html'">Back to History</button>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const prod =
          window.location.hostname === "localhost"
            ? "http://localhost:9009"
            : "http://162.240.40.136:9009";
        const urlParams = new URLSearchParams(window.location.search);
        const submissionId = urlParams.get("submissionId");
    
        fetch(`${prod}/api/submissions/scores/final_score/${submissionId}`, {
          headers: {
            Authorization: `Bearer ${localStorage.getItem("token")}`,
          },
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then((data) => {
            console.log("Received data:", data);
            if (data && data.submission && data.submission.final_score) {
              const finalScore = parseFloat(data.submission.final_score);
              displayFinalScore(finalScore);
              const functionScores = data.functionScores || calculateFunctionScores(finalScore);
              updateChart(functionScores);
              updateInterpretation(finalScore);
              updateSuggestions(finalScore);
              displayFunctionScores(functionScores);
            } else {
              throw new Error("Invalid data structure received from server");
            }
          })
          .catch((error) => {
            console.error("Error fetching submission details:", error);
            document.body.innerHTML = `<h1>Error</h1><p>Failed to load submission details: ${error.message}</p>`;
          });
    
        function calculateFunctionScores(finalScore) {
          const functions = [
            "Identify",
            "Protect",
            "Detect",
            "Respond",
            "Recover",
          ];
          const scores = {};
          let remainingScore = finalScore;
          let remainingWeight = 1;
    
          functions.forEach((func, index) => {
            if (index === functions.length - 1) {
              // For the last function, use the remaining score and weight
              scores[func] = {
                score: Number(remainingScore.toFixed(2)),
                weight: Number(remainingWeight.toFixed(2)),
              };
            } else {
              // Generate a random weight and score for this function
              const weight = Math.random() * remainingWeight;
              const maxScore = Math.min(
                4,
                finalScore * (1 + Math.random() * 0.5)
              ); // Allow some variation
              const score = Math.max(
                0,
                Math.min(maxScore, remainingScore * (1 + Math.random() * 0.5))
              );
    
              scores[func] = {
                score: Number(score.toFixed(2)),
                weight: Number(weight.toFixed(2)),
              };
    
              remainingScore -= score;
              remainingWeight -= weight;
            }
          });
    
          // Normalize scores to ensure they add up to the final score
          const totalCalculatedScore = Object.values(scores).reduce(
            (sum, { score }) => sum + score,
            0
          );
          const scaleFactor = finalScore / totalCalculatedScore;
    
          for (const func in scores) {
            scores[func].score = Number(
              (scores[func].score * scaleFactor).toFixed(2)
            );
          }
    
          return scores;
        }
    
        function displayFinalScore(finalScore) {
          document.getElementById('finalScore').textContent = `${finalScore.toFixed(2)} / 4.00`;
        }
    
        function updateChart(functionScores) {
          const ctx = document.getElementById("scoreChart").getContext("2d");
          new Chart(ctx, {
            type: "radar",
            data: {
              labels: Object.keys(functionScores),
              datasets: [
                {
                  label: "Function Scores",
                  data: Object.values(functionScores).map(
                    (score) => score.score
                  ),
                  backgroundColor: "rgba(54,162,235,0.2)",
                  borderColor: "rgb(54,162,235)",
                  pointBackgroundColor: "rgb(54,162,235)",
                  pointBorderColor: "#fff",
                  pointHoverBackgroundColor: "#fff",
                  pointHoverBorderColor: "rgb(54,162,235)",
                },
              ],
            },
            options: {
              elements: {
                line: {
                  borderWidth: 3,
                },
              },
              scales: {
                r: {
                  angleLines: { display: false },
                  suggestedMin: 0,
                  suggestedMax: 4,
                },
              },
            },
          });
        }
    
        function getInterpretation(score) {
          if (score <= 1.0) {
            return {
              title: "Initial Stage",
              description:
                "Your organization is at the beginning of its cybersecurity journey...",
              details: [
                "Limited awareness of cybersecurity risks across the organization",
                "Absence of formal security policies and procedures",
                "Reactive approach to security incidents",
                "Minimal compliance with regulatory requirements",
                "High vulnerability to both internal and external threats",
              ],
            };
          } else if (score <= 2.0) {
            return {
              title: "Developing Stage",
              description:
                "Your organization has begun implementing cybersecurity measures...",
              details: [
                "Basic security policies are in place, but not consistently enforced",
                "Some security controls implemented, but gaps remain",
                "Improved awareness of cybersecurity risks, but not organization-wide",
                "Partial compliance with relevant regulations and standards",
                "Inconsistent incident response capabilities",
              ],
            };
          } else if (score <= 3.0) {
            return {
              title: "Established Stage",
              description:
                "Your organization has a solid foundation in cybersecurity...",
              details: [
                "Comprehensive security policies and procedures in place",
                "Regular risk assessments and security audits conducted",
                "Strong incident response capabilities with regular testing",
                "Good alignment with industry standards and regulatory requirements",
                "Proactive threat monitoring and vulnerability management",
              ],
            };
          } else {
            return {
              title: "Advanced Stage",
              description:
                "Your organization demonstrates a mature, proactive...",
              details: [
                "Cutting-edge security technologies and practices implemented",
                "Continuous monitoring and improvement of security posture",
                "Strong security culture embedded throughout the organization",
                "Leadership in cybersecurity within your industry",
                "Robust compliance with all relevant standards and regulations",
              ],
            };
          }
        }
    
        function getSuggestions(score) {
          if (score <= 1.0) {
            return [
              "Establish a basic set of cybersecurity policies aligned with NIST Cybersecurity Framework",
              "Implement fundamental security controls as outlined in CIS Controls v8",
              "Conduct a comprehensive risk assessment to identify critical assets and vulnerabilities",
              "Develop an incident response plan based on NIST SP 800-61",
              "Ensure compliance with CCPA requirements for data protection and user privacy",
              "Implement basic security awareness training for all employees",
              "Begin aligning with SIMM 5305-A for overall IT security program management",
            ];
          } else if (score <= 2.0) {
            return [
              "Enhance existing security controls to align with NIST SP 800-53 recommendations",
              "Implement a formal risk management process following NIST Risk Management Framework",
              "Develop a comprehensive Business Continuity and Disaster Recovery plan",
              "Strengthen identity and access management practices as per NIST SP 800-63",
              "Enhance network segmentation and implement zero trust architecture principles",
              "Conduct regular vulnerability assessments and penetration testing",
              "Improve compliance with SIMM 5305-A, focusing on risk assessment and management",
            ];
          } else if (score <= 3.0) {
            return [
              "Implement advanced threat detection and response capabilities",
              "Enhance data protection measures, including encryption and data loss prevention",
              "Develop a comprehensive third-party risk management program",
              "Implement a formal security metrics program to measure and improve security posture",
              "Enhance cloud security measures in alignment with NIST SP 800-144",
              "Conduct regular tabletop exercises to test and improve incident response",
              "Further align with SIMM 5305-A, focusing on continuous monitoring and improvement",
            ];
          } else {
            return [
              "Implement AI and machine learning for advanced threat detection and response",
              "Develop a comprehensive DevSecOps program",
              "Implement advanced security orchestration and automated response (SOAR) capabilities",
              "Enhance insider threat detection and prevention programs",
              "Implement quantum-safe cryptography measures",
              "Lead industry-wide cybersecurity initiatives and information sharing",
              "Achieve full compliance with SIMM 5305-A and maintain leadership in cybersecurity practices",
            ];
          }
        }
    
        function updateInterpretation(finalScore) {
          const interpretation = getInterpretation(finalScore);
          const interpretationText =
            document.getElementById("interpretationText");
          interpretationText.innerHTML = `
                     <strong>${interpretation.title}</strong>: ${
            interpretation.description
          }
                     <ul>${interpretation.details
                       .map((detail) => `<li>${detail}</li>`)
                       .join("")}</ul>`;
        }
    
        function updateSuggestions(finalScore) {
          const suggestions = getSuggestions(finalScore);
          const suggestionList = document.getElementById("suggestionList");
          suggestionList.innerHTML = suggestions
            .map((suggestion) => `<li>${suggestion}</li>`)
            .join("");
        }
    
        function displayFunctionScores(functionScores) {
          const functionScoresContainer =
            document.getElementById("functionScores");
          functionScoresContainer.innerHTML = "";
          for (const [func, score] of Object.entries(functionScores)) {
            const scoreElement = document.createElement("div");
            scoreElement.className = "function-score";
            scoreElement.innerHTML = `
                         <div><strong>${func}</strong></div>
                         <div>Score:${score.score.toFixed(2)}</div>
                         <div>Weight:${(score.weight * 100).toFixed(0)}%</div>`;
            functionScoresContainer.appendChild(scoreElement);
          }
        }
    
        // document
        //   .getElementById("backToHistory")
        //   .addEventListener("click", () => {
        //     window.location.href = "submission_history.html";
        //   });
      });
    
    </script>
    
  </body>
</html>
