<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="dashboard.css">
</head>
<body>
    <div class="absolute-bg"></div>
    <div class="container">
        <h2>Welcome to Your Dashboard</h2>

        <div class="button-group">
            <button id="viewProfileBtn" class="button">
                <span class="material-icons">account_circle</span> View Profile
            </button>
            <button id="self-assessment" class="button">
                <span class="material-icons">security</span> Self-Assessment Questions
            </button>
            <button id="self-assessment-score" class="button">
                <span class="material-icons">security</span> Self-Assessment Scoring
            </button>
            <button id="viewSubmissionsBtn" class="button">
                <span class="material-icons">list</span> View Submissions
            </button>
            <button id="updateProfileBtn" class="button">
                <span class="material-icons">edit</span> Update Profile
            </button>
            <button id="deleteUserBtn" class="button">
                <span class="material-icons">delete</span> Delete Account
            </button>
            <button id="logoutBtn" class="button">
                <span class="material-icons">logout</span> Logout
            </button>
        </div>

        <div id="profileSection" class="hidden">
            <h3>Your Profile</h3>
            <p id="profileDetails"></p>
        </div>

        <div id="updateProfileSection" class="hidden">
            <h3>Update Profile</h3>
            <form id="updateProfileForm">
                <label>Username
                    <input type="text" id="updateUsername" placeholder="Username" required />
                </label>
                <label>Email
                    <input type="email" id="updateEmail" placeholder="Email" required />
                </label>
                <input type="submit" value="Update" class="button" />
            </form>
            <p id="updateMessage"></p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const prod = window.location.hostname === 'localhost'
            ? 'http://localhost:9009'
            : 'http://162.240.40.136:9009'

            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
            }

            const viewProfileBtn = document.getElementById('viewProfileBtn');
            const updateProfileBtn = document.getElementById('updateProfileBtn');
            const deleteUserBtn = document.getElementById('deleteUserBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const profileSection = document.getElementById('profileSection');
            const profileDetails = document.getElementById('profileDetails');
            const updateProfileSection = document.getElementById('updateProfileSection');
            const updateProfileForm = document.getElementById('updateProfileForm');
            const updateMessage = document.getElementById('updateMessage');
            const selfAssessmentBtn = document.getElementById('self-assessment');
            const selfAssessmentScoreBtn = document.getElementById('self-assessment-score');
            const viewSubmissionsBtn = document.getElementById('viewSubmissionsBtn');


            viewProfileBtn.addEventListener('click', async () => {
                try {
                    const response = await fetch(`${prod}/api/users/profile`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json',
                        },
                    });

                    const data = await response.json();

                    if (response.ok) {
                        profileDetails.textContent = `Username: ${data.user.username}, Email: ${data.user.email}`;
                        profileSection.style.display = 'block';
                        updateProfileSection.style.display = 'none';
                    } else {
                        profileDetails.textContent = data.message || 'Failed to fetch profile.';
                    }
                } catch (error) {
                    console.error('Error:', error);
                    profileDetails.textContent = 'An error occurred. Please try again.';
                }
            });

            viewSubmissionsBtn.addEventListener('click', async() => {
                window.location.href = "submission_history.html"
            });

            selfAssessmentBtn.addEventListener('click', () => {
                const userRole = localStorage.getItem('userRole');

                switch(userRole) {
                    case 'cio':
                        window.location.href = 'cio.html';
                        break;
                    case 'iso':
                        window.location.href = 'iso.html';
                        break;
                    // case 'tech':
                    //     window.location.href = 'tech.html';
                    //     break;
                    default:
                        alert('Please select a role before proceeding to the assessment.');
                        window.location.href = 'Choose_Options.html';
                }
            });

            selfAssessmentScoreBtn.addEventListener('click', () => {
                const userRole = localStorage.getItem('userRole');
                window.location.href = 'SIMM_self_assessment.html';

            });

            updateProfileBtn.addEventListener('click', () => {
                profileSection.style.display = 'none';
                updateProfileSection.style.display = 'block';
            });

            updateProfileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('updateUsername').value;
                const email = document.getElementById('updateEmail').value;

                try {
                    const response = await fetch(`${prod}/api/users/profile`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ username, email }),
                    });

                    const data = await response.json();

                    if (response.ok) {
                        updateMessage.textContent = 'Profile updated successfully!';
                        updateMessage.className = 'success';
                        setTimeout(() => {
                            profileSection.style.display = 'block';
                            updateProfileSection.style.display = 'none';
                            profileDetails.textContent = `Username: ${data.user.username}, Email: ${data.user.email}`;
                        }, 2000);
                    } else {
                        updateMessage.textContent = data.message || 'Failed to update profile.';
                        updateMessage.className = 'error';
                    }
                } catch (error) {
                    console.error('Error:', error);
                    updateMessage.textContent = 'An error occurred. Please try again.';
                    updateMessage.className = 'error';
                }
            });

            deleteUserBtn.addEventListener('click', async () => {
                if (confirm('Are you sure you want to delete your account?')) {
                    try {
                        const response = await fetch(`${prod}/api/users/profile`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json',
                            },
                        });

                        const data = await response.json();

                        if (response.ok) {
                            alert('Account deleted successfully!');
                            localStorage.removeItem('token');
                            window.location.href = 'signup.html';
                        } else {
                            alert(data.message || 'Failed to delete account.');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('An error occurred. Please try again.');
                    }
                }
            });

            logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('token');
                window.location.href = 'login.html';
            });
        });
    </script>
</body>
</html>